# ADR-001 – Input Validation and SQL Injection Prevention

## Context

Сервис **"Wishlist"** (FastAPI + SQLModel) обрабатывает пользовательские запросы регистрации, логина и создания желаний.
Потоки **F3 (Query user data)** и **F7 (Store wish)** содержат риск некорректной обработки данных, что может привести к SQL-инъекциям или порче данных.

В **P03** это покрыто нефункциональным требованием **NFR-09 (SQL Injection / input validation)**,
а в модели угроз (**P04**) соответствует риску **R6 (SQL-инъекции)**.

Текущий код не ограничивает длину входных полей, не фильтрует специальные символы и не проверяет MIME при загрузке файлов (будущая фича).

---

## Decision

- Все запросы в базу выполняются через **ORM (SQLModel)** с параметризацией.
- Все входные модели (**UserCreate**, **WishCreate**) проходят строгую валидацию через **Pydantic**:
  - проверка длины, допустимых символов, email-формата;
  - ограничение размера строковых полей ≤ 256 символов;
  - фильтрация HTML/JS (anti-XSS).
- Добавлено **FastAPI middleware** с лимитом `max_request_size = 2MB`.

### При загрузке файлов (будущее расширение API):
- проверка **magic bytes** (`python-magic`);
- допустимые MIME-типы: `image/png`, `image/jpeg`;
- имя файла заменяется на **UUID**;
- запрещены **симлинки** и **path traversal**.

---

## Alternatives

| Подход | Плюсы | Минусы |
|--------|--------|--------|
| Ручная фильтрация строк | Гибкость | Медленно, ненадёжно |
| Внешняя библиотека WAF | Высокая безопасность | Избыточно для малого сервиса |
| ✅ **ORM + Pydantic + middleware** | Баланс безопасности и производительности | Незначительное увеличение латентности |

---

## Consequences

- Существенно снижен риск **SQL-инъекций (R6)**.
- Незначительное увеличение латентности (≈1–3 мс).
- Необходимо обновить **unit-тесты** для проверки негативных сценариев.

---

## Security Impact

- **Закрыт риск R6 (SQL-инъекции)**.
- Выполняется **NFR-09 (валидация входа)**.
- Проверено тестами `tests/test_input_validation.py`
  _(case: `"DROP TABLE"` → rejected)_.

---

## Rollout Plan

1. Ввести feature flag `STRICT_VALIDATION=True`.
2. Провести **DAST scan** (OWASP ZAP baseline).
3. **Canary rollout** в dev-окружении.

---

## Links

- **NFR:** [NFR-09 – SQL Injection / input validation]
- **Потоки:** F3, F7
- **Риски:** R6
- #28 - issue планирования развертывания
