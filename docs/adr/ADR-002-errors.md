# ADR-002 – Secure Error Handling (RFC 7807)

## Context

Сервис возвращает ошибки при логине, ревокации токена и доступе к чужим wishes (**F1**, **F6**, **F8**).
Некоторые из них раскрывают технические детали (stack trace, SQLModel исключения), что нарушает **NFR-05 (SLA ошибок)** и **NFR-08 (Логи и аудит доступа)**.
В модели угроз (**P04**) это отражено как **R1 (Компрометация токенов)** и **R10 (Ошибки авторизации админов)**.

---

## Decision

Все ошибки API стандартизированы под **RFC 7807 (Problem Details)**:

```json
{
  "type": "https://wishlist.app/probs/auth-error",
  "title": "Authentication failed",
  "status": 401,
  "detail": "Invalid credentials",
  "correlation_id": "uuid"
}
```

### Для внутренних ошибок:

Скрываем **stack trace**. В **middleware** добавлен генератор `correlation_id` (**UUID4**).
Формат ошибок тестируется через `pytest test_rfc7807_errors.py`.

---

## Alternatives

| Подход | Плюсы | Минусы |
|--------|--------|--------|
| Стандартные JSON-ответы FastAPI | Простая реализация | Раскрытие внутренних данных |
| Кастомный формат ошибок | Гибкость | Потеря совместимости с клиентами |
| ✅ **RFC 7807** | Единообразие, стандарт, совместимость | Требуется адаптация фронтенда |

---

## Consequences

- Ошибки становятся **единообразными и безопасными**.
- Улучшен **аудит запросов** (через `correlation_id`).

---

## Security Impact

- Закрыты риски **R1 (token disclosure)** и **R10 (auth errors)**.
- Улучшен контроль ошибок (**SLA ≤0.5%** по **NFR-05**).
- Повышена трассируемость по **NFR-08 (logging)**.

---

## Rollout Plan

1. Ввести feature flag `SECURE_ERRORS=True`.
2. Провести **Canary rollout** в dev (10% трафика).
3. Настроить мониторинг логов через **Sentry**.

---

## Links

- **NFR:** NFR-05, NFR-08
- **Потоки:** F1, F6, F8, F10
- **Риски:** R1, R10
- #28 - issue планирования развертывания
