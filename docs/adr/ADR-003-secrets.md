# ADR-003 – Secrets and Token Management

## Context

JWT-секрет и база данных ранее задавались напрямую в `.env`, без проверки TTL токенов и механизма ротации.
Это противоречит требованиям **NFR-01 (JWT TTL и отзыв токенов)** и **NFR-02 (Argon2id)**.
В модели угроз (**P04**) и реестре рисков это связано с **R1 (Компрометация токенов)**, **R2 (Утечка паролей)** и **R5 (Потеря логов ревокации)**.
Потоки **F1, F2, F4, F8, F9, F10** задействованы в этой логике.

---

## Decision

- **JWT access_token** живёт не более **15 минут** (`ACCESS_TTL=900s`).
- Добавлена проверка **отозванных токенов** при каждом запросе (lookup ≤1 мс, Redis или SQLite index).
- Все секреты (`SECRET_KEY`, `DATABASE_URL`) берутся из **переменных окружения**.
- Файл `.env` исключён из репозитория; добавлен `.env.example`.
- Введена функция **ротации JWT-секрета** (`JWT_ROTATE_KEY=true`) и обновления активных ключей.
- Пароли хэшируются через **Argon2id** с параметрами:
  - `memory = 64 MB`
  - `iterations = 3`
  - `parallelism = 2`
- Тесты покрывают случаи:
  - использование **просроченного токена**;
  - использование **отозванного токена**;
  - **хэш и проверка пароля** (`test_password_hash_and_verify`).

---

## Alternatives

| Подход | Плюсы | Минусы |
|--------|--------|--------|
| Хранить ключи в коде | Простота | Крайне опасно |
| Использовать Vault | Высокая безопасность | Избыточно для текущего масштаба |
| ✅ **Переменные окружения + короткоживущий JWT + revocation store** | Баланс безопасности и сложности | Требует поддержки ротации |

---

## Consequences

- Повышена безопасность **аутентификации** и **хранения паролей**.
- Требуется документировать переменные окружения и процессы ротации.

---

## Security Impact

- Закрыты риски **R1, R2, R5**.
- Выполнены **NFR-01 (TTL, revocation)** и **NFR-02 (Argon2id)**.
- Проверено интеграционными тестами `tests/test_auth_tokens.py`.

---

## Rollout Plan

1. Добавить feature flag `USE_ENV_SECRETS=True`.
2. Проверить **JWT TTL** и **revocation** в CI.
3. Провести **пилотное включение** в staging.

---

## Links

- **NFR:** NFR-01, NFR-02, NFR-08
- **Потоки:** F1, F2, F4, F8, F9, F10
- **Риски:** R1, R2, R5
- #28 - issue планирования развертывания
